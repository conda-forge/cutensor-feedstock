{% set version = "2.3.1.0" %}

{% if cuda_compiler_version in (None, "None", True, False) %}
{% set cuda_major = 0 %}
{% else %}
{% set cuda_major = environ.get("cuda_compiler_version", "12.0").split(".")[0] | int %}
{% endif %}

{% set platform = "linux-x86_64" %}  # [linux64]
{% set platform = "linux-ppc64le" %}  # [ppc64le]
{% set platform = "linux-sbsa" %}  # [aarch64]
{% set platform = "windows-x86_64" %}  # [win]
{% set extension = "tar.xz" %}  # [not win]
{% set extension = "zip" %}  # [win]

{% set sha = "b1d7ad37b24cd66a446ae76ac33bd5125aa58007a604cb64fc9c014a8d685940" %}  # [linux64 and (cuda_compiler_version or "").startswith("12")]
{% set sha = "f3763cdc7b03ca08e348efb6faa35d461537390ce7d059e279e415b33dad8291" %}  # [aarch64 and (cuda_compiler_version or "").startswith("12")]
{% set sha = "8df4c1b856c40e72f41d5b92efee5729bf11f00a0e1e3afd546b0d35a360a6cb" %}  # [win64 and (cuda_compiler_version or "").startswith("12")]
{% set sha = "9cb1125f7de01ca319b5c72edeb7169b679b72beacc90354fb18a14056e24372" %}  # [linux64 and (cuda_compiler_version or "").startswith("13")]
{% set sha = "2e4c24bd1621dac7497ca9edf90bfc5dbdcc38490dafd35821066f96f2934aef" %}  # [aarch64 and (cuda_compiler_version or "").startswith("13")]
{% set sha = "8f933694164e310183fffa9cf27d4db43b6edb0fff53b5aa0ab23e705807ac12" %}  # [win64 and (cuda_compiler_version or "").startswith("13")]

package:
  name: cutensor
  version: {{ version }}

source:
  url: https://developer.download.nvidia.com/compute/cutensor/redist/libcutensor/{{ platform }}/libcutensor-{{ platform }}-{{ version }}_cuda{{ cuda_major }}-archive.{{ extension }}
  sha256: {{ sha|default("") }}

build:
  number: 1
  skip: true  # [ppc64le or cuda_compiler_version in (undefined, "None")]
  run_exports:
    - {{ pin_subpackage('cutensor') }}
  ignore_run_exports_from:
    - {{ compiler('cuda') }}
  missing_dso_whitelist:
    - "*/libcuda.so.*"    # [linux]
    - "*/nvcuda.dll"      # [win]
  script_env:
    - cuda_major={{ cuda_major }}

requirements:
  build:
    - {{ compiler('c') }}
    - {{ stdlib("c") }}
    - {{ compiler('cxx') }}
    - {{ compiler('cuda') }}
    - arm-variant * {{ arm_variant_type }}  # [aarch64]
    - cf-nvidia-tools 1                     # [linux]
  host:
    - cuda-version {{ cuda_compiler_version }}
    - libcublas
  run:
    - {{ pin_compatible("cuda-version", min_pin="x", max_pin="x") }}
    - libcublas
  run_constrained:
    - arm-variant * {{ arm_variant_type }}  # [aarch64]

test:
  requires:
    - git
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ compiler('cuda') }}
    - {{ stdlib('c') }}
    # need the libcuda stub for import test
    - cuda-driver-dev  # [linux]
  files:
    - test_load_elf.c  # [linux]

about:
  home: https://developer.nvidia.com/cutensor
  license: LicenseRef-cuTENSOR-Software-License-Agreement
  license_url: https://docs.nvidia.com/cuda/cutensor/license.html
  license_file: LICENSE
  summary: Tensor Linear Algebra on NVIDIA GPUs
  description: |
    The cuTENSOR Library is a first-of-its-kind GPU-accelerated tensor linear
    algebra library providing tensor contraction, reduction and elementwise
    operations. cuTENSOR is used to accelerate applications in the areas of
    deep learning training and inference, computer vision, quantum chemistry
    and computational physics.

    License Agreements:- The packages are governed by the NVIDIA cuTENSOR
    Software License Agreement (EULA). By downloading and using the packages,
    you accept the terms and conditions of the NVIDIA cuTENSOR EULA -
    https://docs.nvidia.com/cuda/cutensor/license.html
  doc_url: https://docs.nvidia.com/cuda/cutensor/index.html
  dev_url: https://developer.nvidia.com/cutensor/downloads

extra:
  recipe-maintainers:
    - ChrisPsa
    - b-kloss
    - conda-forge/cuda
    - v0i0
    - yangcal
    - JeremyWangNVDA
    - leofang
    - jakirkham
    - mtjrider
